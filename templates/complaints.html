<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Bootstrap-->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="/static/css/sidebar.css" />
   
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.0.6/css/dataTables.bootstrap5.css"
    />
    <link
      rel="stylesheet"
      href="https//cdn.datatables.net/2.0.6/css/dataTables.dataTables.min.css"
    />
    <link rel="stylesheet" href="/static/css/complaint.css">
    <title>Document</title>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!--sidebar-->
        <div
          class="col-lg-2 position-fixed"
          style="
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            height: 100%;
            background-color: #1d1d42;
          "
        >
          <div class="list-group">
            <button
              type="button"
              style="color: white; background-color: #1d1d42"
              class="list-group-item list-group-item-action mt-4"
              aria-current="true"
            >
              <h2>Admin</h2>
            </button>
            <button
              type="button"
              onclick="redirectToDashboard()"
              style="color: #72728a; background-color: #1d1d42"
              class="list-group-item list-group-item-action mt-4"
              aria-current="true"
            >
              <span
                class="fa fa-home"
                style="margin-right: 8px; font-size: 20px"
              ></span>
              <span style="font-weight: 600">Dashboard</span>
            </button>

            <button
              type="button"
              onclick="redirectToTicket()"
              style="color: #72728a; background-color: #27274f"
              class="list-group-item list-group-item-action mt-4"
              aria-current="true"
            >
              <span
                class="fa fa-ticket"
                style="margin-right: 8px; font-size: 20px"
              ></span>
              <span style="font-weight: 600">Ticket</span>
            </button>

            
            <button
              type="button"
              onclick="redirectToMap()"
              style="background-color: #1d1d42; color: #72728a"
              class="list-group-item list-group-item-action mt-4"
              aria-current="true"
            >
              <span
                class="fa fa-map"
                style="margin-right: 8px; font-size: 20px"
              ></span>
              <span style="font-weight: 600">Map</span>
            </button>
            <button
            type="button"
            onclick="redirectToLog()"
            style="background-color: #1d1d42; color: #72728a"
            class="list-group-item list-group-item-action mt-4"
            aria-current="true"
          >
            <span

              class="fa fa-history"
              style="margin-right: 8px; font-size: 20px"
            ></span>
            <span style="font-weight: 600">History Log</span>
          </button>
          <button type="button" onclick="redirectUserManagement()" style="background-color: #1d1d42; color: #72728a" class="list-group-item list-group-item-action mt-4" aria-current="true">
            <span class="fa fa-users" style="margin-right: 8px; font-size: 20px"></span>
            <span style="font-weight: 600">Users</span>
        </button>
          </div>
        </div>
        <div
          class="col-lg-10 offset-lg-2"
          style="background-color: #f4f7fe; height: 100vh"
        >
          <div id="ticket" class=" mt-2">
            <h3 style="font-weight: 600">Tickets</h3>
          </div>
          <div class="mt-3"></div>

       
          <div id="cards" class="  row mt-3">
            <div class="col-lg-3">
              <div
                class="card"
                style="box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1)"
              >
                <div class="top"></div>
                <div class="card-body">
                  <div class="icon-number">
                    <div class="text-title">
                      <h5 class="card-title" style="font-weight: bold">Open</h5>
                    </div>
                    <div
                      class="number-icon"
                      style="display: flex; justify-content: space-between"
                    >
                      <h3 style="font-weight: bold; color: #444446">
                        {{ total_complaints}}
                      </h3>
                      <img
                        src="/static/img/BiTicketPerforatedFill.svg"
                        alt=""
                        style="height: 50px"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-3">
              <div
                class="card"
                style="box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1)"
              >
                <div class="top"></div>
                <div class="card-body">
                  <div class="icon-number">
                    <div class="text-title">
                      <h5 class="card-title" style="font-weight: bold">
                        Unresolved
                      </h5>
                    </div>
                    <div
                      class="number-icon"
                      style="display: flex; justify-content: space-between"
                    >
                      <h3 style="font-weight: bold; color: #444446">
                        {{ total_complaints}}
                      </h3>
                      <img
                        src="/static/img/CarbonIncompleteError.svg"
                        alt=""
                        style="height: 50px"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-3">
              <div
                class="card"
                style="box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1)"
              >
                <div class="top"></div>
                <div class="card-body">
                  <div class="icon-number">
                    <div class="text-title">
                      <h5 class="card-title" style="font-weight: bold">
                        Unassigned
                      </h5>
                    </div>
                    <div
                      class="number-icon"
                      style="display: flex; justify-content: space-between"
                    >
                      <h3 style="font-weight: bold; color: #444446">
                        {{ total_complaints}}
                      </h3>
                      <img
                        src="/static/img/MaterialSymbolsPending.svg"
                        alt=""
                        style="height: 50px"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-3">
              <div
                class="card"
                style="box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1)"
              >
                <div class="top"></div>
                <div class="card-body">
                  <div class="icon-number">
                    <div class="text-title">
                      <h5 class="card-title" style="font-weight: bold">
                        Resolved
                      </h5>
                    </div>
                    <div
                      class="number-icon"
                      style="display: flex; justify-content: space-between"
                    >
                      <h3 style="font-weight: bold; color: #444446">4</h3>
                      <img
                        src="/static/img/WhhIssueclosed.svg"
                        alt=""
                        style="height: 50px"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="complaint-details" class="card-view">
            <button id="back-button" style="display: none;" class="btn btn-primary">Back</button>
            <div id="details-content">
              <!-- Details will be populated here -->
            </div>
          </div>
          <div class="mt-3"></div>
          <div id="tableContainer">
          <table
            id="example"
            class="mt-3 complaints-table table table-striped"
            style="
              border-collapse: separate;
              border-spacing: 0;
              border-radius: 10px;
              overflow: hidden;
              background-color: #ededed;
              width: 100%;
            "
          >
            <thead>
              <tr>
                
                <th scope="col">Consumer</th>
                <th scope="col">Complaint Type</th>
                <th scope="col">Description</th>
                <th scope="col">Municipality</th>
                <th scope="col">Barangay</th>
                <th scope="col">Priority</th>
                <th scope="col">Date Reported</th>
                <th scope="col">Status</th>
                <th scope="col">Image</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody class="table-group-divider">
              {% for complaint in complaints %}
              <tr>
                
                <td>{{ complaint['consumer_name'] }}</td>
                <!-- consumer name -->
                <td>{{ complaint['description'] }}</td>
                <td class="truncate" data-full-text="{{ complaint['additionalDetails'] }}">{{ complaint['additionalDetails'][:10] }}...</td> <!-- Truncated additional details -->               <!-- Description -->
                <td>{{ complaint['city'] }}</td>
                <!-- City -->

                <td>{{ complaint['barangay'] }}</td>
                <!-- Barangay -->
                <td><span class="badge bg-primary">Medium</span></td>

                <td>
                  {{ complaint['createdAt'][:10] }} 
                </td>
                <!-- Date Reported -->
                <td>
                  <select style="background-color: transparent; border: none; " class="status-dropdown" data-complaint-id="{{ complaint['$id'] }}">
                   
                    <option value="Open" {% if complaint['status'] == 'Open' %}selected{% endif %}>Open</option>
                    <option value="Pending" {% if complaint['status'] == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Resolved" {% if complaint['status'] == 'Resolved' %}selected{% endif %}>Resolved</option>
                    <option value="Closed" {% if status == 'Closed' %}selected {% endif %}>Closed</option>
                  </select>
              </td>
                <td><a href="#" class="view-image" data-image="{{ complaint['image'] }}" style="text-decoration: none;" data-bs-toggle="modal" data-bs-target="#imageModal">View</a></td>

                <td>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    style="
                      border: none;
                      background-color: transparent;
                      width: 100%;
                    "
                    data-bs-toggle="modal"
                    data-bs-target="#exampleModal"
                  >
                    <i class="fa fa-ellipsis-h text-secondary"></i>
                  </button>

            



                  <!--Modal-->
                  <div
                    class="modal fade"
                    id="exampleModal"
                    tabindex="-1"
                    aria-labelledby="exampleModalLabel"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog modal-xl">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h1 class="modal-title fs-5" id="exampleModalLabel">
                            Assign Crew
                          </h1>
                          <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                          ></button>
                        </div>
                        <div class="modal-body">
                          <div class="col-lg-12 bg-primary">
                     
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                          >
                            Close
                          </button>
                       
                        </div>
                      </div>
                    </div>
                  </div>

                  <!--Second modal for assigning crew-->
                  <div
                    class="modal fade"
                    id="exampleModalToggle2"
                    aria-hidden="true"
                    aria-labelledby="exampleModalToggleLabel2"
                    tabindex="-1"
                  >
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h1
                            class="modal-title fs-5"
                            id="exampleModalToggleLabel2"
                          >
                            Name of crew/team
                          </h1>
                          <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                          ></button>
                        </div>
                        <div class="modal-body">
                          <div class="col-lg-12">
                            <input
                              type="text"
                              class="form-control mt-2"
                              placeholder="ID"
                              aria-label="Recipient's username"
                              aria-describedby="basic-addon2"
                            />
                            <input
                              type="text"
                              class="form-control mt-2"
                              placeholder="Consumer"
                              aria-label="Recipient's username"
                              aria-describedby="basic-addon2"
                            />
                            <input
                              type="text"
                              class="form-control mt-2"
                              placeholder="Description"
                              aria-label="Recipient's username"
                              aria-describedby="basic-addon2"
                            />
                            <input
                              type="text"
                              class="form-control mt-2"
                              placeholder="Location"
                              aria-label="Recipient's username"
                              aria-describedby="basic-addon2"
                            />
                            <input
                              type="text"
                              class="form-control mt-2"
                              placeholder="Level of prioritization: High"
                              aria-label="Recipient's username"
                              aria-describedby="basic-addon2"
                            />
                            <input
                              type="text"
                              class="form-control mt-2"
                              placeholder="Date reported"
                              aria-label="Recipient's username"
                              aria-describedby="basic-addon2"
                            />
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button
                            class="btn btn-primary"
                            data-bs-target="#exampleModalToggle"
                            data-bs-toggle="modal"
                          >
                            Send
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
          <div class="mb-3"></div>
        </div>
      </div>
    </div>

    
<!-- Modal for displaying the image -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-center" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="imageModalLabel">Complaint Image</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div class="col-lg-12">
                  <img id="modalImage" src="" alt="Complaint Image" class="img-fluid">
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
      </div>
  </div>
</div>


    <!--CHange route-->
    <script>
      function redirectToDashboard() {
        window.location.href = "/"; // Redirect to the Flask route
      }
      function redirectToTicket() {
        window.location.href = "/complaints"; // Redirect to the Flask route
      }
      function redirectToMap() {
        window.location.href = "/maps"; // Redirect to the Flask route
      }
      function redirectToLog() {
      window.location.href = "/log-history"; // Redirect to the Flask route
    }
    function redirectUserManagement() {
        window.location.href = "/user-management";
    }
    </script>
    <!--bootstrap-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
   
    <!--DataTable-->
    <script src="https://cdn.datatables.net/2.0.6/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.6/js/dataTables.bootstrap5.js"></script>
    <script>
      $(document).ready(function () {
        $("#example").DataTable({
          // Add custom pagination button styling
          buttons: [
            {
              extend: "previous",
              className: "btn-secondary",
            },
            {
              extend: "next",
              className: "btn-secondary",
            },
            // Add more customization options as needed
          ],
          "order": [[6, "desc"]]
        });
      });

      $('#example').on('click', '.view-image', function(event) {
            event.preventDefault();
            var imageUrl = $(this).data('image');
            $('#modalImage').attr('src', imageUrl);
        });
    </script>
  <script>
    $(document).ready(function() {
        $('.status-dropdown').change(function() {
            var complaintId = $(this).data('complaint-id');
            var newStatus = $(this).val();
            
            $.ajax({
                url: '/update-status',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ complaintId: complaintId, status: newStatus }),
                success: function(response) {
                    if (response.success) {
                        alert('Status updated successfully!');
                    } else {
                        alert('Error updating status: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('AJAX error: ' + error);
                }
            });
        });
    });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
  const ticket = document.querySelector('#ticket');
  const table = document.querySelector('#example');
  const cards = document.querySelector('#cards');
  const tableContainer = document.querySelector('#tableContainer');
  const complaintDetails = document.querySelector('#complaint-details');
  const backButton = document.querySelector('#back-button');
  const detailsContent = document.querySelector('#details-content');

  table.addEventListener('click', function(event) {
    if (event.target.tagName === 'TD' || event.target.tagName === 'TR') {
      const row = event.target.closest('tr');
      if (row) {
        // Populate complaint details
        const complaintData = {
          consumer: row.cells[0].innerText,
          type: row.cells[1].innerText,
          description: row.cells[2].getAttribute('data-full-text'),
          municipality: row.cells[3].innerText,
          barangay: row.cells[4].innerText,
          priority: row.cells[5].innerText,
          dateReported: row.cells[6].innerText,
          status: row.cells[7].querySelector('select').value,
          image: row.cells[8].querySelector('a').dataset.image
        };

        detailsContent.innerHTML = `
        
          <div class="card" style="border: 1px solid #ddd; border-radius: 10px; padding: 20px; background-color: #ffffff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
            <div class="card-body">
              <div class="row">
                <div class="col-lg-9">
                  <div style="display: flex; justify-content: space-between">
                    <div>
                      <h3 class="" style="font-weight: bold"> ${complaintData.type}</h3>
                      <p style="color:rgb(158, 158, 167); font-size: 18px; font-weight: 500"> ${complaintData.dateReported}</p>
                      <p style="color:rgb(158, 158, 167); font-size: 18px; font-weight: 500"> ${complaintData.municipality}, ${complaintData.barangay} </p>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center;">
                    <img class="mr-2" src="/static/img/SolarUserCircleBoldDuotone.svg" style="height: 50px;" alt="">
                    <span class="mt-2" style="font-size: 20px; font-weight: bold; margin-left: 5px; color: #1d1d42"> ${complaintData.consumer}</span>
                  </div>
                  <h3 class="mt-3"> ${complaintData.description}</h3>
                  <p><strong>Image:</strong><br><img src="${complaintData.image}" alt="Complaint Image" style="height: 300px" class="img-fluid"></p>
                </div>
                <div class="col-lg-3">
                  <div id="properties-section">
                    <h4>Properties</h4>
                    <div class="form-group">
                      <label for="complaint-status">Status</label>
                      <select id="complaint-status" class="form-control" required>
                
                        <option value="Open">Open</option>
                        <option value="Pending">Pending</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="complaint-priority">Priority</label>
                      <select id="complaint-priority" class="form-control">
                        <option>Low</option>
                        <option>Medium</option>
                        <option>Urgent</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="complaint-agent">Crew</label>
                      <select id="complaint-agent" class="form-control">
                        <option>Any</option>
                        <option>Resolution Team 1</option>
                        <option>Resolution Team 2</option>
                      </select>
                    </div>
                    <button id="update-button" class="btn btn-primary">Update</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        // Set default values in the properties section
        document.querySelector('#complaint-status').value = complaintData.status;
        document.querySelector('#complaint-priority').value = complaintData.priority;
        document.querySelector('#complaint-agent').value = 'Any'; // Set default or dynamic value if needed

        // Hide table and show complaint details
        tableContainer.style.display = 'none';
        complaintDetails.classList.add('active');
        complaintDetails.style.display ='block';
        cards.style.display = 'none';
        ticket.style.display = 'none';
        backButton.style.display='block';
      }
    }
  });

  backButton.addEventListener('click', function() {
    // Show table and hide complaint details
    complaintDetails.classList.remove('active');
    complaintDetails.style.display='none'
    tableContainer.style.display = 'block';
    cards.style.display = 'flex';
    ticket.style.display = 'block';
    backButton.style.display='none';
  });
});

</script>

  </body>
</html>
